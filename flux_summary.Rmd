---
title: "TEMPESTX flux summary"
author: "Ben"
date: "`r Sys.time()`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '4'
    toc_float: yes
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readr)
library(dplyr)
library(ggplot2)
theme_set(theme_bw())
library(lubridate)
library(tidyr)
library(scales)
```

## Experiment

TEMPESTX is a small-scale soil exclusion experiment nested within the larger
TEMPEST flood plots.

* Three flood plots (40 m x 50 m) separated by 5-50 m
* Four groups of exclusion plots (each 0.75 m2?)
* Each group has four plots (1 control, 1 disturbance control trenched with no barrier, 1 trenched and lined with 1 µm mesh, 1 trenched and lined with 45 µm mesh)
* Plots separated by 2-5 m; plot groups separated by 5-20 m
* Exclusion plots installed in February 2020

![TEMPEST installation](conceptual_figures/PlotInstall.png)
![TEMPEST installation](conceptual_figures/Functional response.png)
![TEMPEST installation](conceptual_figures/Ecosystem cascade.png)


```{r read_files, warning=FALSE}
files <- list.files("7810_data/", pattern = "*.txt", full.names = TRUE, recursive = TRUE)

readfn <- function(x) {
  dat <- read_tsv(x, 
                  # note we're dropping "Item" and a junk column at the end
                  # this is done by skipping their names, and specifying "_" type below
                  col_names = c("Item", "Timestamp", "Collar", "Obs", 
                                "Flux_CO2", "Flux_CH4", "Soil_c", "Soil_m", "Soil_t", 
                                "Length", "R2_CO2", "R2_CH4", "err", "junk"), 
                  col_types = "cTcinnnnninnic",
                  na = c("", "NA", "9999"), # soil probe NA is 9999
                  skip = 1)
  
  # Some of the files output from SoilFluxPro are structurally different :(
  # with one or more missing columns. Record this
  dat %>% 
    mutate(file_structure_prob = nrow(problems(dat))) %>% 
    select(-Item, -junk)
}

lapply(files, readfn) %>% 
  bind_rows(.id = "File") %>% 
  mutate(File = as.integer(File)) ->
  dat

datzero <- filter(dat, Flux_CO2 == 0)
datneg <- filter(dat, Flux_CO2 < 0)
daterr <- filter(dat, err > 0)
```

## QA/QC

### Bad collar numbers

```{r}
dat %>% 
  filter(grepl("[a-z]", Collar)) %>% 
  select(File, Collar) %>% 
  distinct() %>% 
  mutate(File = files[File]) %>% 
  knitr::kable()

# Merge with collar data
read_csv("design/collar_map.csv", col_types = "ccdci") %>% 
  select(-LI8100A_Port) ->
  collars
dat <- left_join(dat, collars, by = "Collar")
```

### Out-and-out errors

Data0 (raw data) has `r nrow(dat)` observations.

We have `r nrow(datzero)` observations with CO2 flux of exactly zero. Removing.

We have `r nrow(datneg)` observations with CO2 flux less than zero. Removing.

We have `r nrow(daterr)` observations with LI-8100 error flags. Removing.

```{r errors}
dat %>% 
  filter(Flux_CO2 > 0) %>% 
  filter(err == 0) %>% 
  select(-err) ->
  dat1
```

Data1 has `r nrow(dat1)` observations (`r round(nrow(dat1) / nrow(dat) * 100, 1)`% of raw).

### Model fit

```{r fits}
r2_min <- 0.5

dat1_co2r2 <- filter(dat1, R2_CO2 < r2_min)
dat1_ch4r2 <- filter(dat1, R2_CH4 < r2_min)
```

We have `r nrow(dat1_co2r2)` observations with CO2 fit R2 less than `r r2_min`. Not removing but FYI.

We have `r nrow(dat1_ch4r2)` observations with CH4 fit R2 less than `r r2_min`. Not removing but FYI.

### Outliers

```{r qaqc-setup}
q_region <- 0.99
q_probs <- c((1 - q_region) / 2, 1 - (1 - q_region) / 2)

qnt <- function(x, p = q_probs) {
  round(quantile(x, probs = p, na.rm = TRUE), digits = 3)
}
qnt_co2 <- qnt(dat1$Flux_CO2)
qnt_ch4 <- qnt(dat1$Flux_CH4)
bad_co2 <- !between(dat1$Flux_CO2, qnt_co2[1], qnt_co2[2])
bad_ch4 <- !between(dat1$Flux_CH4, qnt_ch4[1], qnt_ch4[2])
dat1$Flux_CO2[bad_co2] <- NA_real_
dat1$Flux_CH4[bad_ch4] <- NA_real_
```

Restrict data to `r q_region * 100`%.

The [`r q_probs`] quantiles of `Flux_CO2` are `r qnt_co2`. Changing the `r sum(bad_co2)` values outside of this to NA.

The [`r q_probs`] quantiles of `Flux_CH4` are `r qnt_ch4`. Changing the `r sum(bad_ch4)` values outside of this to NA.

## Overview

Something | Something else
--------- | --------------
First date | `r min(dat1$Timestamp)`
Last date | `r max(dat1$Timestamp)`
N (obs) | `r nrow(dat1)`
N (rounds) | `r length(unique(dat1$File))`

```{r smry}
library(skimr)
dat1 %>% 
  select_if(is.numeric) %>% 
  skim()
```


Notes to self - things to qa/qc: 

* Zero CO2 flux observations
* CO2 flux outside of 95% envelope (currently = 0, 32.4)
* CH4 flux outside of 95% envelope (currently = -5.7, 0.3)
* Ditto for t, m, c
* Distribution of R2 values
* File with structural issues
* Records with Licor err values

## Collar fluxes over time

```{r collar-fluxes}
ggplot(dat1, aes(Timestamp, Flux_CO2, group = Collar, color = Treatment)) + 
  geom_line() + 
  facet_wrap(~paste(Plot, "-", Group))

ggplot(dat1, aes(Timestamp, Flux_CO2, group = Collar, color = Plot)) + 
  geom_line() + 
  facet_wrap(~Treatment)
```

## Treatment fluxes over time {.tabset}

### CO2

```{r trt-fluxes-co2}
# TEMPEST flood test dates
read_csv("design/flood_tests.csv", col_types = "cTT") %>% 
  mutate(Timestamp = NA_POSIXct_) ->
  floods

dat1 %>% 
  group_by(File, Plot, Treatment) %>% 
  summarise(Flux_CO2_sd = sd(Flux_CO2, na.rm = TRUE),
            Flux_CO2 = mean(Flux_CO2, na.rm = TRUE),
            Flux_CH4_sd = sd(Flux_CH4, na.rm = TRUE),
            Flux_CH4 = mean(Flux_CH4, na.rm = TRUE),
            Timestamp = mean(Timestamp),
            .groups = "drop") ->
  dat_trt

# Relative to control
dat1 %>% 
  filter(Treatment == "Control") %>% 
  rename(conCO2 = Flux_CO2, conCH4 = Flux_CH4) %>% 
  select(File, Plot, Group, conCO2, conCH4) %>% 
  # summarise the controls by plot only, not group; we don't want to lose
  # entire group's measurements if the control is missing for some reason
  group_by(File, Plot) %>% 
  summarise(conCO2 = mean(conCO2, na.rm = TRUE),
            conCH4 = mean(conCH4, na.rm = TRUE),
            .groups = "drop") ->
  controls
dat1 %>% 
  left_join(controls, by = c("File", "Plot")) %>% 
  mutate(Flux_CO2 = Flux_CO2 - conCO2,
         Flux_CH4 = Flux_CH4 - conCH4) %>% 
  group_by(File, Plot, Treatment) %>% 
  summarise(Flux_CO2_sd = sd(Flux_CO2, na.rm = TRUE),
            Flux_CO2 = mean(Flux_CO2, na.rm = TRUE),
            Flux_CH4_sd = sd(Flux_CH4, na.rm = TRUE),
            Flux_CH4 = mean(Flux_CH4, na.rm = TRUE),
            Timestamp = mean(Timestamp),
            .groups = "drop") ->
  dat_trt_rel

# Cumulative CO2
dat_trt_rel %>% 
  filter(!is.na(Flux_CO2)) %>% 
  arrange(Timestamp) %>% 
  group_by(Plot, Treatment) %>% 
  mutate(Flux_CO2_cum = cumsum(Flux_CO2)) ->
  dat_trt_rel_cum_co2

# Plots
flood_bands <- geom_rect(data = floods, color = "darkgrey", alpha = 0.5,
                         aes(y = 0, xmin = Start, xmax = End, ymin = -Inf, ymax = Inf))
flood_coords <- coord_cartesian(xlim = c(min(floods$Start) - 24 * 60 * 60 * 3,
                                         max(floods$End) + 24 * 60 * 60 * 3))

ggplot(dat_trt, aes(Timestamp, Flux_CO2, color = Treatment)) + 
  geom_point(na.rm = TRUE) + geom_line() +
  geom_errorbar(aes(ymin = Flux_CO2 - Flux_CO2_sd,
                    ymax = Flux_CO2 + Flux_CO2_sd)) +
  facet_grid(Plot~.) +
  flood_bands + 
  ggtitle("Absolute")

last_plot() + flood_coords + ggtitle("Absolute - flood tests")

ggplot(dat_trt_rel, aes(Timestamp, Flux_CO2, color = Treatment)) + 
  geom_point(na.rm = TRUE) + geom_line() +
  geom_errorbar(aes(ymin = Flux_CO2 - Flux_CO2_sd,
                    ymax = Flux_CO2 + Flux_CO2_sd)) +
  facet_grid(Plot~.) +
  ylab("Flux_CO2 (relative to control)") +
  flood_bands + 
  ggtitle("Relative")

last_plot() + flood_coords + ggtitle("Relative - flood tests")

ggplot(dat_trt_rel_cum_co2, aes(Timestamp, Flux_CO2_cum, color = Treatment)) +
  geom_line() +
  facet_grid(Plot~.) + 
  flood_bands + 
  ggtitle("Cumulative")
```

### CH4

```{r trt-fluxes-ch4}
# Cumulative CH4
dat_trt_rel %>% 
  filter(!is.na(Flux_CH4)) %>% 
  arrange(Timestamp) %>% 
  group_by(Plot, Treatment) %>% 
  mutate(Flux_CH4_cum = cumsum(Flux_CH4)) ->
  dat_trt_rel_cum_ch4

ggplot(dat_trt, aes(Timestamp, Flux_CH4, color = Treatment)) + 
  geom_point(na.rm = TRUE) + geom_line() +
  geom_errorbar(aes(ymin = Flux_CH4 - Flux_CH4_sd,
                    ymax = Flux_CH4 + Flux_CH4_sd)) +
  facet_grid(Plot~.) +
  flood_bands +
  ggtitle("Absolute")

last_plot() + flood_coords + ggtitle("Absolute - flood tests")

ggplot(dat_trt_rel, aes(Timestamp, Flux_CH4, color = Treatment)) + 
  geom_point(na.rm = TRUE) + geom_line() +
  geom_errorbar(aes(ymin = Flux_CH4 - Flux_CH4_sd,
                    ymax = Flux_CH4 + Flux_CH4_sd)) +
  facet_grid(Plot~.) +
  ylab("Flux_CH4 (relative to control)") +
  flood_bands + 
  ggtitle("Relative")

last_plot() + flood_coords + ggtitle("Relative - flood tests")

ggplot(dat_trt_rel_cum_ch4, aes(Timestamp, Flux_CH4_cum, color = Treatment)) +
  geom_line() +
  facet_grid(Plot~.) + 
  flood_bands + 
  ggtitle("Cumulative")
```

## Temperature and moisture {.tabset}

```{r t-vs-m}
dat_tm <- filter(dat1, !is.na(Soil_t), !is.na(Soil_m), Soil_m > 0)
dat_tm$Month <- month(dat_tm$Timestamp)
ggplot(dat_tm, aes(Soil_t, Soil_m, color = Month)) + 
  geom_point() + 
  scale_color_gradient2(low = muted("blue"), 
                        mid = "green", 
                        high = muted("blue"), midpoint = 6.5)
ggplot(dat_tm, aes(Soil_t, Soil_m, color = Plot, size = Flux_CO2)) +
  geom_point(alpha = 0.25, na.rm = TRUE) 
ggplot(dat_tm, aes(Soil_t, Soil_m, color = Plot, size = Flux_CH4)) +
  geom_point(alpha = 0.25, na.rm = TRUE) 
```

### CO2

```{r q10-co2}
dat_co2 <- filter(dat_tm, !is.na(Flux_CO2))

ggplot(dat_co2, aes(Soil_t, Flux_CO2, color = Treatment)) + 
  geom_point(alpha = 0.2) +
  scale_y_continuous(trans = "log10") +
  geom_smooth(method = "lm", formula = y ~ x) + 
  facet_grid(Plot~.)

ggplot(dat_co2, aes(Soil_m, Flux_CO2, color = Treatment)) + 
  geom_point(alpha = 0.2) +
  scale_y_continuous(trans = "log10") +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2, raw = TRUE)) + 
  facet_grid(Plot~.)
```

### CH4

```{r q10-ch4}
dat_ch4 <- filter(dat_tm, !is.na(Flux_CH4))

ggplot(dat_ch4, aes(Soil_t, Flux_CH4, color = Treatment)) + 
  geom_point(alpha = 0.2) +
  #  scale_y_continuous(trans = "log10") +
  geom_smooth(method = "lm", formula = y ~ x) + 
  facet_grid(Plot~.)

ggplot(dat_ch4, aes(Soil_m, Flux_CH4, color = Treatment)) + 
  geom_point(alpha = 0.2) +
  # scale_y_continuous(trans = "log10") +
  geom_smooth(method = "lm", formula = y ~ x) + 
  facet_grid(Plot~.)
```

